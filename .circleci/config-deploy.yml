version: 2.1

executors:
  flyctl-executor:
    docker:
      - image: cimg/openjdk:17.0
    working_directory: ~/repo

jobs:
  deploy:
    executor: flyctl-executor
    steps:
      - checkout
      - run:
          name: Install flyctl
          command: |
            wget -qO- 'https://getfly.fly.dev/linux-x86-64/flyctl.tgz' | tar xz
      - run:
          name: Authenticate with Fly.io
          command: ./flyctl auth docker --access-token $FLY_API_TOKEN
      - run:
          name: Deploy to Fly.io
          command: |
            ./flyctl deploy -i registry.fly.io/$FLY_APP_NAME:$CIRCLE_BUILD_NUM -a $FLY_APP_NAME

workflows:
  version: 2
  deploy_workflow:
    jobs:
      - deploy
